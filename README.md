# Mode AI — Technical Documentation (Vite + React + Capacitor + Android)

This document describes the project architecture, configuration, secrets handling, development workflow, and the release build process to generate an **Android App Bundle (AAB)**.

---

## 1) Tech Stack

- **Frontend:** Vite + React + TypeScript  
- **Mobile wrapper:** Capacitor  
- **Android:** Gradle / Android Studio  
- **External services:**
  - **Firebase** (config via environment variables)
  - **RevenueCat** (subscriptions / in‑app purchases)
  - **Gemini** (Google GenAI SDK)
  - **n8n** (webhooks; treated as secrets)

---

## 2) Repository Structure (high level)

- `src/`  
  Main React/TS application code (UI + logic)
- `services/`  
  Service integrations (Firebase, RevenueCat, Gemini, n8n)
- `dist/`  
  Vite production build output (**not versioned**)
- `android/`  
  Native Android platform generated by Capacitor (**can be regenerated**)

> **Important:** Push to GitHub from the **project root**, not from the `android/` folder.

---

## 3) Environment Variables & Secrets

### 3.1 Rules
- **Never** commit `.env.local` or any files containing real credentials.
- Commit a `.env.example` with placeholders.
- In Vite, any variable exposed to the client must start with `VITE_`.
- In Vite/React code, read variables via `import.meta.env`.

### 3.2 Files
- `.env.local` (DO NOT commit)
- `.env.example` (DO commit)

### 3.3 Recommended variables

#### Gemini
- `VITE_GEMINI_API_KEY`

#### RevenueCat (Android)
- `VITE_REVENUECAT_ANDROID_API_KEY`

#### Firebase (example)
- `VITE_FIREBASE_API_KEY`
- `VITE_FIREBASE_AUTH_DOMAIN`
- `VITE_FIREBASE_PROJECT_ID`
- `VITE_FIREBASE_STORAGE_BUCKET`
- `VITE_FIREBASE_MESSAGING_SENDER_ID`
- `VITE_FIREBASE_APP_ID`

#### n8n (Webhooks)
- `VITE_N8N_WEBHOOK_URL` (and/or multiple webhook URLs as needed)

---

## 4) How secrets are handled in code

### 4.1 Firebase
`firebaseConfig` must read from `import.meta.env` (no hardcoded keys).

### 4.2 RevenueCat
Do **not** store the RevenueCat API key in `capacitor.config.json`.  
Configure RevenueCat at runtime from `services/revenueCatService.ts` using:

- `Purchases.configure({ apiKey: import.meta.env.VITE_REVENUECAT_ANDROID_API_KEY, ... })`

### 4.3 Gemini
In Vite, **do not** use `process.env.API_KEY`.  
Use:

- `import.meta.env.VITE_GEMINI_API_KEY`

> **Security note:** If the Gemini API key must be truly secret, use a **backend/proxy** (Cloudflare Worker / Firebase Function / Cloud Run) so the client never receives the key.

### 4.4 n8n Webhooks
Webhook URLs that embed unique tokens should be treated as **secrets**:
- Move them to env vars (e.g., `VITE_N8N_WEBHOOK_URL`)
- Recommended: add real authentication (header token) or route through a backend proxy.

---

## 5) GitHub: what to commit vs what to ignore

### 5.1 Minimum `.gitignore` (recommended)

```gitignore
# Node / Vite
node_modules/
dist/
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# Env
.env
.env.*
!.env.example

# IDE
.idea/
.vscode/
*.iml

# Android / Capacitor
android/.gradle/
android/.idea/
android/build/
android/app/build/
android/local.properties

# Firebase (if used)
android/app/google-services.json

# Keystores / signing
*.jks
*.keystore
*.p12

# OS
.DS_Store
Thumbs.db
```

### 5.2 Sensitive files that must NOT be committed
- `.env.local`
- `android/local.properties`
- `android/app/google-services.json` (if using Firebase)
- `*.keystore`, `*.jks`

### 5.3 If a secret was already tracked
```bash
git rm --cached .env.local
git rm --cached android/local.properties
git rm --cached android/app/google-services.json
git commit -m "Remove secrets from tracking"
```

---

## 6) Development workflow (Web)

### 6.1 Install dependencies
```bash
npm install
```

### 6.2 Run in development mode
```bash
npm run dev
```

### 6.3 Production build (web)
```bash
npm run build
```

---

## Quick start (Android)

If the `android/` folder is not committed to the repository, you can regenerate it anytime from the project root:

```bash
npm install
npm run build
npx cap add android
npx cap sync android
npx cap open android
```

## 7) Android (Capacitor): regenerate `android/` from scratch

Run from the **project root**.

### 7.1 Remove the existing Android folder (optional)
**Windows (PowerShell):**
```powershell
Remove-Item -Recurse -Force .\android
```

**macOS/Linux:**
```bash
rm -rf android
```

### 7.2 Build web + add Android + sync
```bash
npm install
npm run build
npx cap add android
npx cap sync android
```

### 7.3 Open in Android Studio
```bash
npx cap open android
```

---

## 8) Generate the AAB (Android App Bundle)

### 8.1 From Android Studio (recommended)
1. **Build → Generate Signed Bundle / APK…**
2. Select **Android App Bundle**
3. Choose **release**
4. Select your **keystore** (or create one)
5. Finish

Typical output path:
- `android/app/release/app-release.aab`  
(Path may vary depending on Gradle version/config.)

---

## 9) Keystore (release signing)

### 9.1 Create a keystore (if you don’t have one yet)
```bash
keytool -genkeypair -v -keystore modeai-release.keystore -alias modeai -keyalg RSA -keysize 2048 -validity 10000
```

**Best practices:**
- Store it **outside** the repo
- Back it up securely (it’s critical)
- Never publish/share it

---

## 10) Quick troubleshooting

### 10.1 `npx cap sync android` fails
- Run `npm install` and retry `npx cap sync android`.
- Check Capacitor versions in `package.json`.

### 10.2 `.env.local` values not applied
- Vite reads `.env.local` at `npm run build` time.
- Ensure you run:
  - `npm run build`
  - `npx cap sync android`

### 10.3 RevenueCat not working on web
- Expected behavior: the service is **native-only**.
- Confirm `Capacitor.isNativePlatform()` and check logs.

### 10.4 Signing errors when generating AAB
- Verify keystore path, alias, and passwords.
- Confirm you’re building `release`.

---

## 11) Pre‑publish checklist (public GitHub repo)

- [ ] `.env.local` is not committed
- [ ] `.env.example` is committed
- [ ] `capacitor.config.json` contains no API keys
- [ ] `services/firebase.ts` has no hardcoded config values
- [ ] `services/revenueCatService.ts` reads `import.meta.env`
- [ ] `services/n8nService.ts` has no tokenized webhook URLs hardcoded
- [ ] `services/geminiService.ts` uses `import.meta.env.VITE_GEMINI_API_KEY`
- [ ] `.gitignore` includes keystores and Android local files
- [ ] Search for leaked strings (`goog_`, `/webhook/`, `AIza`, `sk_`, etc.)

---

## 12) Useful commands

### Build + sync Android
```bash
npm run build
npx cap sync android
```

### Open Android Studio
```bash
npx cap open android
```

### Search for potential leaks (examples)
**PowerShell:**
```powershell
Select-String -Path .\**\* -Pattern "goog_|/webhook/|AIza|sk_|apiKey" -List
```

---

